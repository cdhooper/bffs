                             BFFS 1.6
     An AmigaDOS FileSystem handler for the 4.4 BSD UNIX fast filesystem
                   (©) 1991 - 2018 by Chris Hooper

        *** This guide is NOT complete and probably never will be ***


                         U S E R   M A N U A L


     Line #   Page #   Section
   ----------------------------------------
       28        2     Introduction
       58        3     Compatibility
      139        5     Building a MountList entry
      167        6     Using HDToolBox to automatically mount partitions
      249        8     Maintenance Utilities
      398       11     Expert Setup
      416       12     Credits and Acknowledgements
      443       13     Known Bugs
      459       14     Appendix A: MountList.BFFS information
      540       16     Appendix B: Implementation Information
      601       17     Appendix C: The BSD 4.2 File System
      662       19     Appendix D: Differences between BFFS and Amiga FFS
      699       20     Appendix E: Information useful to programmers
      760       21     Appendix F: Troubleshooting Suggestions
INTRODUCTION:

    First, a definition is in order.  The major portion of this
product consists of a software application which implements a disk
filesystem.  A filesystem is simply a way of organizing multiple
data files within the confines of a logical device.  Without a
filesystem, that device would appear as nothing more than a single
large file.  In order to store more than one file on a device, it
is necessary to assert some organization to be able to locate and
size the separate files.  This is what a filesystem does.

    BFFS Stands for Berkeley Fast FileSystem, a reimplementation of
the UNIX filesystem, as described in the 1983 CSRG paper, "A Fast
File System for UNIX."  In the ten years following the 1983 paper,
the Berkeley Fast Filesystem became the predominant disk organizer
for most UNIX implementations.  Although there have been subtle
changes made by various vendors since the original, the basic idea
and organization of the filesystem has not changed.  If you would
like more details, please see APPENDIX B for implementation information
or consult the CSRG paper mentioned above.

The filesystem handler and utilities in this package require AmigaDOS
2.04 or higher.  The usefulness of a package such is this is that one
may seamlessly use the same logical media while running AmigaDOS as
one would use running UNIX.  It can also be used for data migration.
For instance, you can write a floppy on a UNIX machine at work (or
school), then use the files stored on that disk directly on your
machine at home.  This package does not allow you to execute the
applications intended for other platforms on your Amiga.

COMPATIBILITY:

The BFFS filesystem attempts to attain compatibility with the Berkeley
4.2 and 4.3 BSD filesystems.  Since other UNIX (and compatible) producers
base their system's filesystem on the BSD 4.2 FFS, this product may
be useful with filesystems created by those other systems.  The tested
filesystem types follow:
    SunOS 4.1 and 4.1.1
        BFFS should be highly compatible with these releases
        of the BSD filesystem, as BFFS was created against it.
        In order to write a floppy, you need to do the following:
           1. Make sure you have a floppy drive on the Sun
           2. Format the floppy
                I recommend "fdformat -lv"
           3. Create a filesystem on the floppy
                I recommend "newfs -i 16384 -c 80 -t 2 -m 0 /dev/rfd0c"
                as this seems to give the best capacity
           4. Mount the floppy on a directory (you MUST be root)
                ie: "mount /dev/fd0c /mnt"
           5. Copy your files to the floppy
           6. Unmount the floppy
                ie: "umount /dev/fd0c"
    SunOS 4.1.2 (Solaris 1.0.1) and SunOS 4.1.3
        BFFS should be able to at least read filesystems created
        with this OS.  I have done quite a few read and write tests.
        BFFS did not corrupt the filesystem, as far as I could tell.
    Amiga UNIX (SVR4)
        Did minimal testing, but read/write seems stable.
    BSD 4.3 filesystems
        The previous version of BFFS came with newfs and fsck ports
        from BSD 4.3.  It was created and distributed before the
        BSD 4.4 filesystem came into existence, which may explain
        why it happily trashed newer BSD 4.4 filesystems.  This version
        is still compatible with BSD 4.3 filesystems, but...
    BSD 4.4 filesystems
        BFFS can autodetect BSD 4.3 and BSD 4.4 filesystems and knows
        how to deal with the differing structures in each.
        newfs and fsck included in this distribution are now ports
        of the Berkeley utilities dated 20-Jul-94 and 8-Jun-94
        respectively.  fsck has been used extensively throughout the
        testing process of BFFS.  Since the above filesystems (with
        some exceptions) seem compliant to fsck, I would assume that
        BSD 4.3 and BSD 4.4 FFS should not have a problem reading
        BFFS-written filesystems.
    BSD UFS V1
	Newer versions of BSD, including NetBSD circa 1994 introduced
	changes in the filesystem called V1.  These include structural
	changes in the superblock and cylinder group areas to add 64-bit
        support for summary information.  The BFFS 1.6 FileSystem has been
        enhanced to detect and update these fields on a newer filesystem.
        Most of the command tools (newfs, dump, etc), do not know how to
        deal with the changes.  The only exception is fsck, which was
	modified to be able to use the proper summary information if the
	filesystem is UFS V1.  Since the newfs shipped with BFFS does not
	support this version, it will still create filesystems prior to
	the V1 format.  Newer versions of NetBSD's UFS and fsck can
	up-convert filesystems to the V1 format.  On current NetBSD, use
	the following arguments when creating a filesystem for best
	performance with BFFS:
	    newfs -B be -O 1 <device>
	When creating a multiple-GB filesystem, you may also want to add
        the "-n <inode-count>" option to limit the number of inodes.

    BSD UFS V2
	BFFS can detect this version and will force the filesystem to
	read-only mode.

    ENDIAN NOTES:  Use BFFSFilesystem to read and write both 68k and x86
        BSD Fast filesystems.  This version automatically handles detecting
        and swapping byte orders of these filesystems.  There is also a
        read-only version of this filesystem called BFFSFilesystem.ro.  If
        you do not require x86 support, then the BFFSFilesystem.be version
        (supporting only big endian) is smaller and faster.

        The command line tools (newfs, fsck, dumpfs, etc) do not understand
        little endian filesystems.  A new port of the current version of
        these utilities would enable that support.

    See Appendix A for information on selecting an Amiga device driver
    and appropriate filesystem handler.

BUILDING A MOUNTLIST ENTRY:

    I suggest you use the sample MountList entry (MountList.BFFS) as a
prototype for creating your own MountList entry.  You can find line-by-line
documentation in the MountList.BFFS file.  For the generic case, it should
be (at most) necessary to check the following MountList fields:
    FileSystem, Device, Unit, BlocksPerTrack, Surfaces, LowCyl, and HighCyl

    You can add this new MountList entry to your system's MountList
(Devs:MountList) or put it in a separate file.  If you kept the same device
name as the example MountList, you would type:
        Mount BFFS: from MountList.BFFS
    Say you chose instead to call your BFFS partition BF0 and add it to
your Devs:MountList.  In that case, you would type:
        Mount BF0:

    If you are mounting a filesystem which already has a UNIX BSD file
system on it, then you should be able to CD to that device, just like any
other AmigaDOS file system device.  If you want to create a new BFFS
file system, you must first use newfs before BFFS can access it.  Do the
newfs command after you have mounted the partition.

    Once you have the filesystem working, you might try tweaking some of
the following fields:
    Mount, Priority, Buffers, Reserved, and PreAlloc

Please see Appendix A for descriptions of the MountList fields.

USING HDTOOLBOX TO AUTOMATICALLY MOUNT PARTITIONS:

    Before you follow the below procedure, I recommend you first
try mounting the filesystem using a MountList entry.  A filesystem
compatibility problem before the machine even boots could be a
major headache!  If this happens to you, see Appendix F.

    If you are using a hard disk, you most likely already have a
partition set aside for the UNIX filesystem.  If not, you need to
first set up the disk and partition using HDToolBox.  Consult your
AmigaDOS manual for help.

    Start HDToolBox and select "Partition Drive."  Choose the
partition you want to make a BFFS partition, then select the
"Advanced Options" button.  Pick the "Change File System for
Partition" button.

    If this is an Amiga UNIX partition, then the File System type
is probably "Reserved Partition."  Otherwise, the most likely case
is "Fast File System."  Be careful in your selections!  If you
don't watch what you were doing, you might accidentally pick a
partition with AmigaDOS data you want to keep.  If the File System Type
is "Custom File System," make especially sure you know what's going on
there.  If you're at all unsure, click the "Cancel" button and start over.

    Select the "Custom File System" button and fill in the
"Identifier =" field.  I recommend the value 0x42464653 ('BFFS'),
but you can use and filesystem type you want.  The NetBSD people
are partial to 'BSDx' - where x would be 'R', 'S', 'D', 'E', 'F',
'G', 'H', etc depending on how NetBSD is using the partition.
The disadvantage to this scheme is that for every UNIQUE file
system Identifier you want to mount as a BFFS filesystem, you
must add the BFFS filesystem to the RDB with that Identifier.

    "Use custom boot code?" should be set to "No, " unless it is
required by NetBSD to boot.

    Set the "beginning:" and "end:" fields as you would if those
were the "Reserved" and "PreAlloc" fields of the MountList.  Then,
Click on the "Ok" button.

    Click on the "Add/Update File Systems" button.  This screen
allows you to update the RDB on the disk with the new version of
BFFS. Every time you assign a different Identifier to one of your
partitions, you need to "Add New File System" with that same
Identifier.

    Click on the "Add New File System" button now.  Change the
"Enter Filename of File System" to point to the file where you
have the new BFFSFileSystem.  Change the "DosType for File System"
to be the same as you entered as the Identifier for the Custom
File System. The "Version" of the filesystem does not matter.
Click on "Ok" when you are done.  Then click "Ok" on the "File
Systems" screen.

    If you have more partitions to add as BFFS filesystems, do
those in the same manner as above.  Note that if you use the same
Identifier for all filesystems, you do not need to "Add New File
System" more than once.  This is not an option for NetBSD users.

    When done, Click "Ok" on the "Partitioning Drive" screen.  Then
Click on "Save Changes to Drive."  After that operation is complete,
you will need to reboot for the machine to mount the filesystem.

    The Reserved and PreAlloc fields of a MountList entry may be changed
in HDToolBox by clicking on "Partition Drive."  From there, you need to
select the partition by clicking on the appropriate partition in the bar
graph.  Select the "Advanced Options" button, then the "Change File
System for Partition" button.  The Reserved field is "beginning" under
"Reserved blocks at."  The PreAlloc field is "end" under "Reserved
blocks at."  Be sure to press enter after updating these fields, as
what could be described as a bug in HDToolBox will ignore updates to
these fields otherwise.

** SPECIAL NOTE **
    The PreAlloc and Reserved fields are treated as unsigned longwords
by HDToolBox.  They are specified as signed longwords when using the
MountList.  This basically means that when you want to specify a value
such as -1 in HDToolBox, you must use 4GB - value.  Thus, 4GB - 1 =
4294967295.  To tell the filesystem not to attempt to read a disk
label, put 4294967295 in the box "reserved blocks at the beginning."

MAINTENANCE UTILITIES

    There are several support programs included in this distribution
of the BFFS system package.  These programs were very helpful during
the development of BFFSFileSystem and will hopefully be just as useful
to you.  Below is just an overview of the function of those programs.
Read the documentation file associated with the utility if you need
more information.

o  bffstool
        This graphical program is used to both monitor and modify the
        operation of a running BFFS filesystem.  You are able to
        change filesystem buffers, modify the write sync timers,
        clear statistics, and change operating flags (auto symlink,
        ignore case, dir comments, unix paths. and read only).
        The program is not very friendly to modern Amiga resolutions
        and user interfaces.

o  chmod
        Change file (user / group / other) permissions

o  chown
        Change ownership (user id / group id) of a file per the
        AmigaDOS 3.0 packet.

o  cmp
        A simple utility to perform a binary comparison between two files
        on disk.

o  dbprint
        Display BFFS debug messages (note this program requires a
        CLI window, and will take over the window).  It may be safely
        aborted at any time by pressing control-C.  You must be running
        the debug version of the filesystem to see any output.

o  dcp
        Dcp is a program that can copy to/from devices and files.
        You can specify either the physical device and partition
        or the AmigaDOS device.  This program was originally
        distributed separately.  It is a replacement for the
        filetodev and devtofile programs distributed in version 1.1
        of BFFS.  This is the latest version of dcp and is included
        here mainly for completeness.

o  disklabel
        This program will let you assign multiple BSD partitions
        within a single AmigaDOS partition.  WARNING:  These
        partitions are not compatible with the way NetBSD partitions
        were implemented on the Amiga.  This might have changed at
        some point, but I doubt it.  This program is a port of the
        4.4 BSD program of the same name.  See the disklabel.8 and
        disklabel.5.5 manual pages for more information.

o  dump
        This program can be used to make a backup image of files in
        the filesystem.  It is a port of the 4.4 BSD program of the
        same name.  See the dump.8 manual page for more information.
        See also the restore command below.

o  dumpfs
        Most users will probably never need to use this program.
        It is a port of the BSD 4.4 program of the same name, and
        similar to edumpfs will print out information from the
        superblock of the filesystem.

o  edumpfs
        Most users will probably never need to use this program.
        It prints out information on the disk label and superblock,
        as organized by newfs and modified by the filesystem.

o  fs_thrash
        A simple program to blindly create/delete/read/write files in
        a filesystem.  Running multiple copies at the same time were
        used to test BFFS's filesystem metadata management.  It is
        probably not useful for anyone but me.

o  fsck
        This program will check your filesystem for inconsistencies.
        It is a port of the 4.4 BSD program of the same name.
        NOTE: This program doesn't like SunOS filesystems as much as it
        does BSD filesystems.  If fsck tells you the disk requires a label
        for a SunOS disk, supply the location of the superblock:
            fsck -b 16 <DEVICE:>
        Otherwise, you should be able to just type: "fsck <DEVICE:>"
        See the fsck.8 manual page for more information.

o  ln
        This program can create a hard or soft link using the BFFS
        filesystem.  I wrote it because I couldn't get MakeLink
        under AmigaDOS 2.04 to create soft links.  Command line
        syntax is similar to the Unix command of the same name,
        except this version can accept multiple names which will
        point to a single destination.

o  ls
        Quick directory lister showing extended AmigaDOS 3.0 permissions
        and file owner/group.  Can also show true UNIX permissions, file
        size in blocks, and file inode number on a UNIX filesystem.  The
        goal for this utility is to be as similar as possible to the UNIX
        ls command.

o  mknod
        Create Unix device nodes (block and character special) using
        a mounted BFFS filesystem.  This program uses a new packet assigned
        by Randell Jesup (ACTION_CREATE_OBJECT), which may be used to
        create an arbitrary file type.

o  newfs
        This program will create a new filesystem on the specified device.
        If disklabel was not first run on the partition, the size of the
        entire partition will be used for the filesystem.  Warning: This
        program unmercifully writes over an existing filesystem if you
        specify the wrong device.  There is no confirmation prompt -- it
        will immediately start writing the device.  This is a port of the
        4.4 BSD program of the same name.  See the newfs.8 manual page for
        more information.

o  rdb
        Edit the RDB area of most disk devices.  This is a crude
        command-line program, but can do most things HDToolBox can do (and
        a few it won't).  I wrote it because my IVS Trumpcard wouldn't talk
        to HDToolBox and I wanted to have more than *one* automount partition.

o  restore
        This program will restore a BSD format dump file to a BFFS
        filesystem.  It is a port of the BSD 4.4 restore command.
        Creation of UNIX special files are supported.  See the
        restore.8 manual page for more information.  See also the dump
        command above.

o  sync
        Command to force filesystems to flush dirty data to disk.  This
        is similar to the UNIX command of the same name.

o  touch
        Command to set file time(s) for BFFS filesystems, with SYSV syntax.

o  tunefs
        This program can be used to make minor parameter changes to the
        superblock of a filesystem.  It is a port of the BSD 4.4 program
        of the same name.  Note that BFFS ignores most parameters which
        can be set by tunefs.  See the tunefs.8 manual page for more
        information.

o  umount
        This program may be used to "unmount" an Amiga device.  It works
        by sending the "ACTION_DIE" packet to the device and then removing
        the device from the DOS LockList (similar to "assign dismount <dev>").

EXPERT SETUP

For those with previous experience with setting up BFFS or other
AmigaDOS filesystems, here are the things you need to do:

o   Copy BFFSFilesystem to L:
o   Create a MountList entry for the filesystem.  You must specify:
        FileSystem, Device, Flags, StackSize, Priority, Globvec,
        LowCyl, HighCyl, Surfaces, BlocksPerTrack, Buffers,
        Reserved, Prealloc, and DosType.  If you have any questions,
        please consult the sample MountList.BFFS file (in APPENDIX A)
        or the section on building a MountList entry.
o   Mount the filesystem
o   If all went well, you should be able to CD to the filesystem,
        as you've named in the MountList.  If all did not go well,
        hopefully your Amiga did not crash.  Consult the Appendices
        to ensure you've configured everything correctly.

CREDITS AND ACKNOWLEDGEMENTS

    Chris Hooper       Main Author, program concept and development
    Bill Moore         Original DOS interface Author, program concept, and
                       main motivator of the need for filesystem.
    Ken Dyke           Assembly Author (stack and diskchange), always
                       the quickest reference for my needs!!  :)
    Randell Jesup      Gave AmigaDOS filesystem insight, helpful hits,
                       and new packets throughout!
    Dominic Giampaolo  Beta Tester, if it's a bug, he's seen it
    Arthur Hoffmann    Beta Tester, no matter how stable, he'll find
                       some problem.  :)
    Thomas Kroener     Beta Tester, tried quite a few combinations
    Tero Manninen      Beta Tester, the fastest enforcer hit finder,
                       and has been helping out since BFFS 1.2!!
    Ty Sarna           Beta Tester, not only does he find bugs, he
                       also suggests cool improvements!
    Stefan Sticht      Beta Tester, found hits in 1.25
    Lutz Vieweg        Beta Tester, reported many fixable bugs and
                       submitted HD_Raw_Sun_Floppy_Label


Please remember that this software is freeware and these people
have volunteered their time for this package to become a reality.
Everyone above deserves a pat on the back for making our lives on
the Amiga a little nicer.

KNOWN BUGS

There are a few problems which still remain with the current
implementation of BFFS.  A couple are:

Disk volume nodes aren't fully supported.  This mainly affects
removable media.  Basically, if you intend on removing the disk,
make SURE there are no AmigaDOS locks on that volume.

BFFS does not support newer filesystems than FFS from 4.4 BSD.
Specifically NetBSD UFS v2 and Sun Solaris FFS contain enhancements
(such as journaling) which are not supported.  BFFS might be able
to mount and read filesystem images from these newer operating systems,
but I do not recommend trying to write to them.


APPENDIX A:  MountList.BFFS information
    FileSystem entry has to change if you don't put BFFSFileSystem in l:
    Device depends on the device in which your filesystem resides:
        For 2090 controllers, use hddisk.device.
        For 2091 controllers, use scsi.device.
        For IVS controllers, use IVS_SCSI.device.
        For filesystems in a file, use fmsdisk.device (©) Matt Dillon.
        For floppies, use newer mfm.device from Commodore (Consultron)
                    [ or messydisk.device from MessyDOS (©) ]
    Unit entry changes depending on device.
        Quick notes:
            IVS SCSI addresses begin at 1, not 0
            2090(A) SCSI addresses begin at 3; MFM is at 1 and 2
            2091 and A3000 SCSI addresses are the same as the Unit.
    Mount entry should be set to your preference, with 0 meaning mount
        at first access and 1 meaning mount immediately.
    StackSize should be left at 512.  BFFS allocates stack at runtime.
    Priority should be left at 5.  Should you have a need to change it,
        the filesystem will not really care.
    GlobVec should be left at -1.
    LowCyl should be set to the beginning cylinder of the filesystem.
        For Sun-formatted disks, this is best set at 0.
        For AmigaDOS disks with Amiga partitions and Unix partitions,
            set this to the starting cylinder number for the partition.
            If you do not know this, you should be able to find this
            out using HDToolBox.  Look at the starting cylinder for
            the partition under advanced options.
    HighCyl should be set to the ending cylinder of the filesystem.
        It is used to determine the maximum block which may be read
        from or written to within the filesystem.  Failure to set
        this parameter correctly may result in symptoms such as the
        filesystem not being read, the machine crashing, or data
        loss in other disk partitions.
    Surfaces should be set per your drive's geometry [number of heads].
        This information may be acquired from HDToolBox.
    BlocksPerTrack should be set per your drive's geometry [may be
        specified as sectors per track]. This information may be
        acquired from HDToolBox.
    Buffers should be set to the number of blocks of system memory you
        you want to devote to the cache.  Each block is the size of a
        filesystem fragment block, which is nominally 1024 bytes unless
        specified differently to newfs.  A minimum of eight is enforced
        for proper operation of the filesystem.

    Reserved is the Unix partition on the media you want to access.
        It can also specify that no disk label is present:
          -1 = no disk label
        0x00 = access first partition
        0x01 = access second partition
        0x02 = access third partition
        0x03 = access fourth partition
        0x04 = access fifth partition
        0x05 = access sixth partition
        0x06 = access seventh partition
        0x07 = access eighth partition
        0x08 = do not scan for a Sun disk label
        0x10 = do not scan for a BSD disk label
        ** You may combine the 0x08 or 0x10 with 0x00-0x07
           to achieve a combination of parameters.
    PreAlloc is used to modify the startup defaults for the filesystem
        0x01 = Turn on automatic symlink resolution
        0x02 = Turn off case independence.  If you are familiar with the
               Amiga filesystem, you probably want to leave this on.
        0x04 = Make filesystem respect UNIX paths (/, ..) and not AmigaDOS paths
        0x08 = Turn on directory comments (symlink destinations)
        0x10 = Turn on directory comments (inode, perms, user, grp, etc)
        0x20 = Invert the definition of the other/group permission bits
        0x40 = Report space free relative to minfree (instead of actual)

        Bits 8-15 represent a signed byte which is the GMT offset for
            the filesystem when dealing with file times.  I recommended
            you use BFFSTool to get the settings you want, then put the
            PreAlloc number it gives you into your MountList.
            Examples: USA PDT (Pacific daylight savings time) = 0xf900
                      USA PST (Pacific std time)              = 0xf800
        You may combine any of the above to alter multiple parameters.
        Note that HDToolBox will require this field (known as "end" there)
        to be specified as an unsigned decimal.
    DosType should be left as 0x42464653 ("BFFS"), unless you have a
        specific need for a different DosType (such as NetBSD partition).

APPENDIX B: Implementation Information

    There are a few points where this implementation of the
Berkeley Fast Filesystem differs substantially from the original
product described in the 1983 CSRG paper, "A Fast File System for
UNIX."

    It is recommended you read the above paper before the
following information.  If you do not have that paper, APPENDIX C
provides some quick detail on the BSD 4.2 Fast File System.

    Files which have been opened and written to at least once are
automatically extended in allocation to the size of an entire
filesystem block.  When the file is closed, if it only requires
allocation within the direct blocks of the inode, it will be
trimmed down to the size specified in the inode.  Fragment blocks
will be moved near others to conserve full filesystem blocks.  With
this algorithm, only full filesystem blocks need be found and
allocated.  This reduces the overhead and complexity of file block
allocation when writing to files.  It also means that multiple
file write streams will have higher performance as the filesystem
frags are not thrashed about as they are written.  Given sufficient
cache, the fragment relocations at file close are implemented
very efficiently (zero copy) because the cache implementation will
simply redirect queued dirty frags to new addresses.

    This program ignores superblock parameters such as interleave
and maxcontig and always strives to locate the next block
allocation contiguous with the previous disk block allocation.
The read and write routines will then batch up as large a transfer
as possible when requesting data to be read from or written to the
media.  This should improve the transfer rate for large files.

    New files have a preference for the nearest cylinder group
(cg) to that of the parent directory.  New directories are located
in cgs having the most free inodes (and data blocks available).

    Files will continue to grow in the same cylinder group until
all available filesystem blocks have been allocated.  At that
point, the cg with the largest number of available blocks is
chosen to continue allocation.

    It is recommended a BSD 4.2 filesystem be kept at most 90%
full in order for the block layout policies to remain effective.
This is true for the BFFSFileSystem as well.  One thing you might
want to note is that the filesystem requires at least one empty
filesystem block in order to deal with any file allocation.
Because of this, the Info command is only told the number of
complete filesystem blocks which are still available on the disk.
So, you might find that creating a small file may not induce an
apparent increase in disk utilization.  In that case, the file was
able to be allocated in a fragment block from the disk.  If you
need to know, BFFSTool can provide the exact information from the
superblock.

    When performing file reads or writes, the filesystem strives
to combine as many contiguous disk fragments together as possible
when a disk transfer is necessary.  The smallest disk transfer
possible will always be the fragment size.  Any read or write
request smaller will be buffered through the cache.

APPENDIX C: The BSD 4.2 File System

    The original AT&T System 7 filesystem organized data on the
disk as follows:
    [  Superblock  |  Inode Area  |  Data Area  ]

    The Superblock describes the parameters which make up the
filesystem.  These include the number of blocks in the file
system, the number of inodes, and a pointer to a list of free
blocks.

    A file is made up of an inode and some number of data blocks
from the data area of the disk.  The inode is the center of
activity in the Berkeley filesystem.  It contains information such
as file block locations, file ownership, access permissions, and
file type.

    The problem with this system comes as disks got larger and
transfer rates faster.  When accessing a typical file, the inode is
first read, then some data from the file is typically transferred.
The distance between the inode and its data blocks would typically
incur a long seek across the disk.  This seek is time intensive, and
the file data may not be retrieved or written before the disk head
can physically get there.

    The BSD 4.2 Fast File System gets around this problem by
breaking the disk up into smaller chunks called cylinder groups.
Each cylinder group contains an inode area and a data area.  The
idea is to place data related to an inode within the same or near
cylinder group to reduce the disk head movement.  This also tends
to reduce file fragmentation as the disk blocks for the file are
located closer together.

    Another optimization made in the BSD filesystem was the
introduction of filesystem blocks which are made of up smaller
fragment blocks. File blocks are allocated in units of filesystem
blocks, with the remainder allocated to fragment blocks.  This
scheme guarantees to localize filesystem size blocks of file data
together, achieve greater disk throughput by minimizing seek time
and maximizing the transfer block size.

So, a BSD 4.2 filesystem may be organized on the disk as follows:
    [  cg 0  |  cg 1  |  cg 2  |  cg 3  |  ... ...  ]

Where each cg is organized as:
    [  Data Area | Superblock | Inode Area | Data Area  ]

    You may wonder why the inode area is located inside the data
area. The reason is another goal in the development of the Berkeley
FFS -- to improve disaster recoverability.  You will notice the
superblock is replicated in every cylinder group on the disk.  The
first cg contains the only working superblock, the others contain a
static copy of the original superblock, which are not usually
referenced after filesystem creation.  The cylinder group metadata
(inode area and superblock) float to a different fixed location inside
each cylinder group. This reduces the possibility that a single head
or cylinder loss could jeopardize all data on the disk.

    The above additions make for a much more complex implementation,
consuming fast CPU time in place of slow disk time.

APPENDIX D: Differences between BFFS and Amiga FFS

    When executing directory listings, you should notice less disk
head movement with BFFS than with the Amiga FFS.  This is mainly due
to the required localization of inodes.  What will typically happen is:
    A seek to read the directory inode if it is not already cached
    A seek to read the directory's filenames and inode numbers
    Multiple seeks in the inode area to read file inodes
** Up to 72 inodes can be stored in a single cylinder of a floppy

    You will notice that that most "list" programs show soft links
as directories.  This is a fault of the list program and not the
filesystem.  With AmigaOS 2.04, most applications do not work correctly
with soft links.  More will work correctly in the future (AmigaOS 3.0+).

    Permissions for files are as expected.  Except that Write permission
and Delete permission appear identical.  The real permissions are not
identical, however.  As of BFFS 1.5, the permissions set in the parent
directory of a file determine whether it may be deleted.  Write permission
is as expected.  OS 3.0 extended information is supported for a file's
group and other permissions, though only the owner permissions are
respected for file access.

    The Execute bit will determine if a directory may be accessed.
    The Read bit may in the future determine if the entries in a
            directory are visible.
    The Write bit will determine if files may be created in the directory.

    Directory comments are used for BFFS to provide additional information
about the file listing.  BFFS does not allow the user to change the directory
comments like the AmigaOS FFS.  These informational comments must be enabled
using BFFStool (or via a MountList entry).  There are two types of comments,
and these may be combined.  The first is symlink and char/block device
information.  The second is the inode information not presented by the OS 2.0
FileInfoBlock.  See Appendix A, PreAlloc field 0x08 and 0x10 values for
information on how to enable comments.

APPENDIX E: Information useful to programmers

BFFS supports the following packets (ACTIONs):
        IS_FILESYSTEM           LOCATE_OBJECT           EXAMINE_OBJECT
        READ                    FINDINPUT               EXAMINE_NEXT
        WRITE                   FINDOUTPUT              EX_OBJECT
        SEEK                    FINDUPDATE              EX_NEX
        END                     FREE_LOCK
        DELETE_OBJECT           RENAME_OBJECT           RENAME_DISK
        CREATE_DIR              COPY_DIR                PARENT
        DISK_INFO               SAME_LOCK               SET_PROTECT
        INFO                    WRITE_PROTECT           MORE_CACHE
        DISK_CHANGE             INHIBIT                 FLUSH
        DIE                     CURRENT_VOLUME          MAKE_LINK
        SET_OWNER               EXAMINE_FH              READ_LINK
        GET_DISK_FSSM           FREE_DISK_FSSM          SET_DATE

It might (eventually) support:
        ADD_NOTIFY              COPY_DIR_FH             FH_FROM_LOCK
        REMOVE_NOTIFY           PARENT_FH               EXAMINE_ALL
        SET_FILE_SIZE                                   

The FORMAT packet is implemented by newfs, a separate program.
The TIMER packet is used internally to know when to sync fs data
and also turn off the floppy motor.


Sending BFFS an ACTION_DIE will close all files, deallocate all dynamic
memory, and put the filesystem in a quiescent state.  Querying system
statistics (ie: by using BFFSTool) will reactivate the filesystem.
I've encountered problems with messydisk.device supporting the
TD_REMCHANGEINT packet correctly.  Because of this, the filesystem will
look for this driver name and substitute trackdisk.device for the disk
change information.  I've also seen a problem with the older version of
mfm.device (2.0).  Apparently it cannot handle reading a chunk of data
across a cylinder boundary.  I know this is fixed in version 40.9, and
most likely earlier versions as well.

There is an additional packet type the filesystem supports:
ACTION_FS_STATS (value 2999, unofficial) is used by BFFSTool to get a
pointer to the statistics data structures.  Once BFFSTool has that
pointer, it has immediate access to many of BFFSFileSystem's internal
variables.

BFFS supports some additional EntryTypes in the FileInfoBlock of
Examined file locks.  Specifically:
        ST_BDEVICE   -10          ST_LIFO      -13
        ST_CDEVICE   -11          ST_FIFO      -14
        ST_SOCKET    -12          ST_WHITEOUT  -15

Per the AmigaDOS 3.0 extensions to the FileInfoBlock, OwnerID
and GroupID, as well as the group and other permissions are now
available in the FileInfoBlock.

Packets implemented in addition to above:
        ACTION_CREATE_OBJECT   2346     (published packet)
        ACTION_SET_DATES       2998     (unofficial)
        ACTION_SET_TIMES       2997     (unofficial)
        ACTION_SET_PERMS       2996     (unofficial)
        ACTION_GET_PERMS       2995     (unofficial)

APPENDIX F: Troubleshooting Suggestions

Situation:  You went against my advice of testing with a MountList
            entry first and now you are very sad as your computer has a
            "Software Failure".  In other words, the machine crashes on
            boot, with no escape.
Suggestion: Obviously you don't want the machine to try to automount the
            disk.  Your hard drive controller may have a jumper that you
            can remove or insert to disable autoboot.  If so, do this.
            If not, you might try unplugging your drive from the bus on
            powerup, then back in after the machine has booted (off floppy,
            or if you're lucky another drive).  Then use your handy dandy
            disk partitioner thing (HDToolBox for Commodore controllers)
            to remove that partition.  If that doesn't work, you might try
            using my rdb editor to manually remove the entry for that
            partition from the RDB.

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

Situation: Your Amiga does not read any BFFS floppies and you are using
           mfm.device.  It seems to (almost) work, as the drive grinds back
           and forth several times before giving you an error (when you set
           Reserved=0 in MountList).

Possible Problem: You are using an old version of mfm.device.  Get
           a newer version.  I know version 40.9 works ok.

Possible Problem: The floppy has an incompatible superblock.  If it's
           a 386BSD floppy (or any other floppy written with an Intel
           processor), make sure you use the BFFSFileSystem or similar
           handler and not BFFSFileSystem.be or similar.

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

Situation: The floppy is not accessed at all, and you get nothing
           when you try to access bf0:

Possible Problem: The filesystem handler does not exist where the
           MountList tells AmigaDOS to find it.  The example
           MountList.BFFS requires BFFSFileSystem be put in L:

Possible Problem: The device specified in the MountList does not
           exist in the expected location.  If no path is specified,
           AmigaDOS checks the Devs: directory.

Possible Problem: The wrong Unit was specified in the MountList.
           This can actually cause a lot of programs to crash
           unexpectedly for some reason.

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

Situation: Amiga GURUs when disk is changed

Possible Problem: You're using an older version of messydisk.device
                  which doesn't support disk change interrupts correctly.
                  Upgrade messydisk or get the new mfm.device from
                  Consultron or Commodore.

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


Situation: Amiga GURUs at some seemingly random point.

Suggestion: Drop some email to amiga@cdh.eebugs.com describing your
            problem and what I can do to duplicate it.  If I can't
            duplicate it (or find it relatively easy), it's not in
            there.  ;)

Solution: Disassemble; fix; reassemble yourself.  :)
          ** Update: Now that source is available, you can instead
          view source, fix, recompile yourself.  :)
